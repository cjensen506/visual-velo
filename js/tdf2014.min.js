function brushstart(){}function brushmove(){0!=currentDisplay||0==brush.extent()[0]&&yZoomScale.invert(yScaleConstant(GCPlace))==brush.extent()[1]?1!=currentDisplay||0==brush.extent()[0]&&yZoomScale.invert(yTimeScaleConstant(GCTime))==brush.extent()[1]||(document.getElementById("GCcheckbox").checked=!1,GConly=!1):(document.getElementById("GCcheckbox").checked=!1,GConly=!1),updateData(0)}function brushend(){updateData(0)}function brushed(){var t=slide.extent()[0];d3.event.sourceEvent&&(t=xSlider.invert(d3.mouse(this)[0]),slide.extent([t,t])),handle.attr("cx",xSlider(t)),CurrentOpacity=t,svg.select("g.riders").selectAll("g.EachRider").filter(function(t){return"true"!=d3.select(this).select("path").attr("brushed")}).selectAll("path").attr("stroke-opacity",t),svg.select("g.riders").selectAll("g.EachRider").filter(function(t){return"true"!=d3.select(this).select("path").attr("brushed")&&"Abandon"==d3.select(this).select("path").attr("status")}).selectAll("circle").attr("opacity",t)}function updateData(t){0==currentDisplay?(GConly?yScale.domain([1,GCPlace]):yScale.domain([yScaleConstant.invert(yZoomScale(brush.extent()[0])),yScaleConstant.invert(yZoomScale(brush.extent()[1]))]),svg.select("g.riders").selectAll("path").transition().duration(t).attr("d",function(t){return PathString(t.values.map(function(t){return t.Rank}))}),svg.select("g.riders").selectAll("circle").transition().duration(t).attr("cy",function(t){return yScale(t.values[t.values.length-1].Rank)}),svg.select(".Rider.axis").transition().duration(t).call(yAxis).select(".yaxis_label").text("Place")):1==currentDisplay&&(GConly?yTimeScale.domain([d3.time.format("%S").parse("0"),GCTime]):yTimeScale.domain([yTimeScaleConstant.invert(yZoomScale(brush.extent()[0])),yTimeScaleConstant.invert(yZoomScale(brush.extent()[1]))]),svg.select("g.riders").selectAll("path").transition().duration(t).attr("d",function(t){return PathString(t.values.map(function(t){return t.GapForm}))}),svg.select("g.riders").selectAll("circle").transition().duration(t).attr("cy",function(t){return yTimeScale(t.values[t.values.length-1].GapForm)}),svg.select(".Rider.axis").transition().duration(t).call(yTAxis).select(".yaxis_label").text("Time Gap")),svg.select(".Rider.axis").selectAll(".tick").filter(function(t){return 0===t}).attr("visibility","hidden")}function GCfunction(t){GConly=t,t&&0==currentDisplay?brush.extent([0,yZoomScale.invert(yScaleConstant(GCPlace))]):t&&1==currentDisplay?brush.extent([0,yZoomScale.invert(yTimeScaleConstant(GCTime))]):t||brush.extent([0,1]),brush(d3.select(".brush").transition().duration(TransitionTime)),brush.event(d3.select(".brush")),updateData(TransitionTime)}function PathString(t){if(1==t.length)return"";if(0==currentDisplay){for(var e="M "+xScale(StageToDistance(1))+" "+yScale(t[0]),a=2;currentStage>=a&&!isNaN(+t[a-1]);a++)e=e+" L "+xScale(StageToDistance(a))+" "+yScale(t[a-1]);return e}if(1==currentDisplay){for(var e="M "+xScale(StageToDistance(1))+" "+yTimeScale(t[0]),a=2;currentStage>=a&&!isNaN(+t[a-1]);a++)e=e+" L "+xScale(StageToDistance(a))+" "+yTimeScale(t[a-1]);return e}}var w=800,h=500,Rmargin={top:10,right:20,bottom:10,left:100},Pmargin={top:10,right:Rmargin.right,bottom:20,left:Rmargin.left},Pwidth=w,Pheight=80,xScale=d3.scale.linear().range([Rmargin.left,w+Rmargin.left]),yScale=d3.scale.linear().range([Rmargin.top,h+Rmargin.top]),yScaleConstant=d3.scale.linear().range(yScale.range()),yTimeScale=d3.time.scale().range(yScale.range()),yTimeScaleConstant=d3.time.scale().range(yScale.range()),yZoomScale=d3.scale.linear().range(yScale.range()).domain([0,1]),Py=d3.scale.linear().range([Pheight+Pmargin.top,Pmargin.top]),StageColor=d3.scale.ordinal().domain([0,1]).range(["#bdbdbd","#636363"]),StageToDistance=d3.scale.ordinal(),dataset,timegap,currentStage,currentDisplay=0,maxRiders=0,maxTime=0,TotalStages=21,GConly=!1,Sformat=d3.time.format("+%S"),Mformat=d3.time.format("+%M:%S"),Hformat=d3.time.format("+%H:%M:%S"),ToolTipFormat=d3.time.format("%-Hh %-Mm %-Ss"),DefaultOpacity=.4,CurrentOpacity=.4,TransitionTime=500,GCPlace=30,GCTime=d3.time.format("%M").parse("20"),yAxis=d3.svg.axis().scale(yScale).orient("left"),yTAxis=d3.svg.axis().scale(yTimeScale).orient("left").tickFormat(d3.time.format("%-Hh %-Mm")),dropDownCountry=d3.select("#CountriesDrop").attr("data-placeholder","Select a Country").style("width","350px"),dropDownTeam=d3.select("#TeamDrop").attr("data-placeholder","Select a Team").style("width","350px"),dropDownRider=d3.select("#RiderDrop").attr("data-placeholder","Select Riders").style("width","350px"),ProfileSvg=d3.select("#ProfilePlot").append("svg:svg").attr("width",Pwidth+Pmargin.left+Pmargin.right).attr("height",Pheight+Pmargin.top+Pmargin.bottom).append("svg:g"),svg=d3.select("#RiderGraph").append("svg:svg").attr("width",w+Rmargin.left+Rmargin.right).attr("height",h+Rmargin.top+Rmargin.bottom).append("svg:g"),area=d3.svg.area().x(function(t){return xScale(t.TotalDistance)}).y0(Pheight+Pmargin.top).y1(function(t){return Py(t["altitude (m)"])}),svgZoom=d3.select("#ZoomBar").append("svg").attr("width",20).attr("height",h+Rmargin.top+Rmargin.bottom),brush=d3.svg.brush().y(yZoomScale).extent([0,1]).on("brushstart",brushstart).on("brush",brushmove).on("brushend",brushend),arc=d3.svg.arc().outerRadius(10).startAngle(-.5*Math.PI).endAngle(function(t,e){return e?-1.5*Math.PI:.5*Math.PI}),brushg=svgZoom.append("g").attr("class","brush").call(brush);brushg.selectAll(".resize").append("path").attr("transform","translate(10,0)").attr("d",arc),brushg.selectAll("rect").attr("width",20),brushstart(),brushmove();var Smargin={top:10,right:20,bottom:15,left:20},width=200-Smargin.left-Smargin.right,height=50-Smargin.bottom-Smargin.top,xSlider=d3.scale.linear().domain([0,1]).range([0,width]).clamp(!0),slide=d3.svg.brush().x(xSlider).extent([0,0]).on("brush",brushed),svgSlider=d3.select("#OSlider").append("svg").attr("width",width+Smargin.left+Smargin.right).attr("height",height+Smargin.top+Smargin.bottom).append("g").attr("transform","translate("+Smargin.left+","+Smargin.top+")");svgSlider.append("text").style("font-family","sans-serif").style("font-size","18px").style("text-anchor","middle").attr("x",xSlider(.5)).attr("y",Smargin.top-3).text("Opacity"),svgSlider.append("g").attr("class","SliderAxis").attr("transform","translate(0,"+height+")").call(d3.svg.axis().scale(xSlider).tickSize(0).ticks(0)).select(".domain").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","halo");var slider=svgSlider.append("g").attr("class","slider").call(slide);slider.selectAll(".extent,.resize").remove(),slider.select(".background").attr("height",height);var handle=slider.append("circle").attr("class","handle").attr("transform","translate(0,"+height+")").attr("r",9);slider.call(slide.event).call(slide.extent([DefaultOpacity,DefaultOpacity])).call(slide.event),d3.csv("Data/TDF2014Results.csv",function(t){return temptime=null,t.Gap.length<4?temptime=Sformat.parse(t.Gap):t.Gap.length<7?temptime=Mformat.parse(t.Gap):temptime=Hformat.parse(t.Gap),null==temptime,{Country:t.Country,Name:t.Name,Rank:t.Rank,Stage:t.Stage,Team:t.Team,"gap(s)":t["gap(s)"],GapForm:temptime}},function(t){d3.csv("Data/TDF2014_stagesTrim.csv",function(e,a){var r=d3.nest().key(function(t){return t.Name}).entries(t),n=d3.nest().key(function(t){return t.StageNum}).entries(a);currentStage=d3.max(r,function(t){return t.values.length}),maxRiders=d3.max(t,function(t){return+t.Rank}),maxTime=d3.max(t,function(t){return+t["gap(s)"]}),maxDate=d3.max(t,function(t){return t.GapForm}),StageToDistance.domain(d3.range(1,d3.max(n,function(t){return+t.key})+1)).range(d3.map(n,function(t){return len=t.values.length,+t.values[len-1].TotalDistance}).keys()),xScale.domain([0,d3.max(a,function(t){return+t.TotalDistance})]),yScale.domain([1,maxRiders]),yScaleConstant.domain(yScale.domain()),yTimeScale.domain([d3.time.format("%S").parse("0"),maxDate]),yTimeScaleConstant.domain(yTimeScale.domain()),Py.domain([0,d3.max(a,function(t){return+t["altitude (m)"]})]).nice();var s=d3.set(r.map(function(t){return t.values[0].Country})).values();s.sort();var l=d3.set(r.map(function(t){return t.values[0].Team})).values();l.sort(),l.unshift("Select a Team");var i=d3.nest().key(function(t){return t.Team}).sortKeys(d3.ascending).key(function(t){return t.Name}).sortKeys(d3.ascending).entries(t),o=d3.set(r.map(function(t){return t.key})).values();o.sort(),o.unshift("Select a Rider"),dropDownCountry.selectAll("option").data(s).enter().append("option").text(function(t){return t}).attr("value",function(t){return t}),$("#CountriesDrop").trigger("chosen:updated"),$("#CountriesDrop").on("change",function(t,e){var a="";void 0!=e&&(a=e.selected),svg.select("g.riders").selectAll("path").attr("brushed",!1).attr("stroke","black").attr("stroke-width",1).attr("stroke-opacity",CurrentOpacity),svg.select("g.riders").selectAll("circle").attr("opacity",CurrentOpacity),svg.select("g.riders").selectAll("path").filter(function(t){return t.values[0].Country==a}).attr("brushed",!0).attr("stroke","red").attr("stroke-width",3).attr("stroke-opacity",1),svg.select("g.riders").selectAll("g.EachRider").filter(function(t){return"true"==d3.select(this).select("path").attr("brushed")&&"Abandon"==d3.select(this).select("path").attr("status")}).selectAll("circle").attr("opacity",1),document.getElementById("TeamDrop").selectedIndex="0",$("#TeamDrop").trigger("chosen:updated"),$("#RiderDrop").val(""),$("#RiderDrop").trigger("chosen:updated")}),dropDownTeam.append("option").attr("value",""),dropDownTeam.selectAll("option").data(l).enter().append("option").text(function(t){return t}),$("#TeamDrop").trigger("chosen:updated"),$("#TeamDrop").on("change",function(t,e){var a="";void 0!=e&&(a=e.selected),svg.select("g.riders").selectAll("path").attr("brushed",!1).attr("stroke","black").attr("stroke-width",1).attr("stroke-opacity",CurrentOpacity),svg.select("g.riders").selectAll("circle").attr("opacity",CurrentOpacity),svg.select("g.riders").selectAll("path").filter(function(t){return t.values[0].Team==a}).attr("brushed",!0).attr("stroke","red").attr("stroke-width",3).attr("stroke-opacity",1),svg.select("g.riders").selectAll("g.EachRider").filter(function(t){return"true"==d3.select(this).select("path").attr("brushed")&&"Abandon"==d3.select(this).select("path").attr("status")}).selectAll("circle").attr("opacity",1),document.getElementById("CountriesDrop").selectedIndex="0",$("#CountriesDrop").trigger("chosen:updated"),$("#RiderDrop").val(""),$("#RiderDrop").trigger("chosen:updated")}),dropDownRider.append("option").attr("value",""),dropDownRider.selectAll("optgroup").data(i).enter().append("optgroup").attr("label",function(t){return t.key}).selectAll("option").data(function(t){return t.values}).enter().append("option").text(function(t){return t.key}).attr("value",function(t){return t.key}),$("#RiderDrop").trigger("chosen:updated"),$("#RiderDrop").on("change",function(t,e){e.selected;svg.select("g.riders").selectAll("path").attr("brushed",!1).attr("stroke","black").attr("stroke-width",1).attr("stroke-opacity",CurrentOpacity),svg.select("g.riders").selectAll("circle").attr("opacity",CurrentOpacity),svg.select("g.riders").selectAll("path").filter(function(t){return $.inArray(t.key,$("#RiderDrop").val())>=0}).attr("brushed",!0).attr("stroke","red").attr("stroke-width",3).attr("stroke-opacity",1),svg.select("g.riders").selectAll("g.EachRider").filter(function(t){return"true"==d3.select(this).select("path").attr("brushed")&&"Abandon"==d3.select(this).select("path").attr("status")}).selectAll("circle").attr("opacity",1),document.getElementById("CountriesDrop").selectedIndex="0",$("#CountriesDrop").trigger("chosen:updated"),document.getElementById("TeamDrop").selectedIndex="0",$("#TeamDrop").trigger("chosen:updated")});ProfileSvg.append("svg:g").attr("class","stages").selectAll("path").data(n).enter().append("svg:g").attr("id","stagegroup").append("path").attr("d",function(t){return t.area=this,area(t.values)}).attr("fill",function(t){return StageColor(t.key%2)}).attr("stroke",function(t){return d3.rgb(StageColor(t.key%2)).darker()}).attr("stroke-width",1.5);d3.selectAll("g#stagegroup").append("rect").attr("y",Pmargin.top).attr("x",function(t){return xScale(t.values[0].TotalDistance)}).attr("height",Pheight).attr("width",function(t){return len=t.values.length-1,xScale(t.values[len]["distance (km)"])-Pmargin.left}).style("fill","none"),d3.selectAll("g#stagegroup").append("text").style("font-family","sans-serif").style("font-size","16px").style("text-anchor","middle").attr("y",Pmargin.top+Pheight+Pmargin.bottom).attr("x",function(t){return middlestage=Math.round(t.values.length/2),xScale(t.values[middlestage].TotalDistance)}).text(function(t){return t.key}),ProfileSvg.append("text").style("font-family","sans-serif").style("font-size","16px").style("text-anchor","middle").attr("y",13).attr("x",xScale(xScale.domain()[1]/2)).text("Total Distance & Stage Profile"),ProfileSvg.append("text").style("font-family","sans-serif").style("font-size","16px").style("text-anchor","middle").attr("transform","translate(0,0) rotate(-90,"+xScale(StageToDistance(20))+",50)").attr("y",50).attr("x",xScale(StageToDistance(20))).text("ITT"),ProfileSvg.append("g").attr("class","axis axis--y").attr("transform","translate("+(Pmargin.left-25)+",0)").call(d3.svg.axis().scale(Py).orient("left").ticks(3).innerTickSize(0).outerTickSize(0)).append("text").attr("transform","translate("+-Pmargin.left*(2/3)+","+(Pheight/2+Pmargin.top)+") rotate(-90)").attr("x",4).attr("dy",".32em").attr("text-anchor","middle").attr("font-size","16px").text("Elevation (m)"),d3.select("#ProfilePlot").select("g.axis--y").selectAll("path").remove();svg.append("svg:g").attr("class","riders").selectAll("path").data(r).enter().append("g").attr("class","EachRider").append("path").attr("brushed",!1).attr("name",function(t){return t.key}).attr("team",function(t){return t.values[0].Team}).attr("country",function(t){return t.values[0].Country}).attr("d",function(t){return PathString(t.values.map(function(t){return t.Rank}))}).attr("stroke","black").attr("stroke-width",1).attr("stroke-opacity",DefaultOpacity).attr("fill","none").attr("place",function(t){return t.values[t.values.length-1].Rank}).attr("timegap",function(t){return t.values[t.values.length-1].GapForm}).attr("status",function(t){return"undefined"==typeof t.values[currentStage-1]?"Abandon":"Still Riding"}).on("mouseover",function(t){var e=d3.select(this).attr("name"),a=d3.select(this).attr("place"),r=new Date(d3.select(this).attr("timegap")),n=xScale(StageToDistance(currentStage))+$("#RiderGraph").position().left+20,s=0;0==currentDisplay?s=yScale(a):1==currentDisplay&&(s=yTimeScale(r)),s>h+Rmargin.top&&(s=h+Rmargin.top-20),s+=$("#RiderGraph").position().top,d3.select("#tooltip1a").style("left",n+"px").style("top",s-60+"px").select("#place").text(a),d3.select("#tooltip1a").select("#name").text(e),d3.select("#tooltip1a").select("#timegap").text(ToolTipFormat(r)),d3.select("#tooltip1a").select("#Team").text(d3.select(this).attr("team")),d3.select("#tooltip1a").select("#Country").text(d3.select(this).attr("country")),d3.select("#tooltip1a").classed("hidden1a",!1),d3.select(this).attr("stroke-width",5).attr("stroke-opacity",1)}).on("mouseout",function(){d3.select("#tooltip1a").classed("hidden1a",!0),"true"==d3.select(this).attr("brushed")?d3.select(this).attr("stroke-width",3):d3.select(this).attr("stroke-width",1).attr("stroke-opacity",CurrentOpacity)}).each(function(t){t.values.length<currentStage&&t.values.length>1&&d3.select(this.parentNode).append("circle").attr("class","AbandonMark").attr("r",2).attr("cx",xScale(StageToDistance(t.values.length))).attr("cy",yScale(t.values[t.values.length-1].Rank)).style("fill","black")});svg.append("g").attr("class","Rider axis").call(yAxis).attr("transform","translate("+Rmargin.left+",0)").append("text").attr("class","yaxis_label").attr("transform","translate(-"+(Rmargin.left-12)+","+((h-Rmargin.top-Rmargin.bottom)/2+Rmargin.bottom)+") rotate(-90)").attr("dy",".71em").style("text-anchor","middle").style("font-size","20px").text("Place"),svg.select(".Rider.axis").selectAll(".tick").filter(function(t){return 0===t}).attr("visibility","hidden")})});var config={".chosen-select":{max_selected_options:10},".chosen-select-deselect":{allow_single_deselect:!0},".chosen-select-no-single":{disable_search_threshold:10},".chosen-select-no-results":{no_results_text:"Oops, nothing found!"},".chosen-select-width":{width:"95%"}};for(var selector in config)$(selector).chosen(config[selector]);